# TokFlow

[English](README.md)

大規模言語モデルにより逐次的に生成されるトークンをバッファリングし、必要な置換処理を行いながら出力するユーティリティ

## 本ライブラリは何ができる？

下のように小さな かけら のようになった文章の断片＝トークンを逐次入力したとき、置換が必要な文字列を順次置換しながら出力する。

このとき、トークンのバッファリングして遅延出力を行うことで、置換前のトークンは出力しないようにできる

```python
["He","llo"," ","t","h","ere","!<","N","L>m","y ","nam","e"," ","is"," tokfl","ow.","<","N","L>N","ice"," to ","me","et you."]
```

この例では、 `<NL>` の出現を検知し `\n` に置換しながら出力する。

<img src="tokflow.gif">


- 置換条件として、好きな文字列を置換対象に指定可能
- 複数の置換条件を指定可能


## 本ライブラリの用途は？

大規模言語モデルによる逐次文章生成で特殊トークンを逐次置換しながら出力する用途のために開発したが、ほかの文字列ストリーム処理でも活用可能。

# インストール

```
pip install tokflow
```

# 使い方/サンプルコード

```python
import time
from tokflow import TokFlow

TOKEN_GENERATOR_MOCK = ["He", "llo", " ", "t", "h", "ere", "!<", "N", "L>m", "y ", "nam", "e", " ", "is", " tokfl", "ow.",
                  "<", "N", "L>N", "ice", " to ", "me", "et you."]

# "<NL>" を "\n" に置換する。 "<NL>" は検索対象文字列。 "n" は置換先文字列
# 置換条件は複数指定可能。
tokf = TokFlow([("<NL>", "\n")])

for input_token in TOKEN_GENERATOR_MOCK: 
    # トークン（文章のかけらとなる1,2文字程度の文字列）を順次入力していく。トークンは内部でバッファリングされる。
    output_token = tokf.put(input_token)

    # output_token に今出力可能な出力トークンが出力される。
    # トークンのバッファリング中に検索対象文字列が出現する可能性がある場合は
    # 出力トーンは空文字となる。
    print(f"{output_token}", end="", flush=True)

    # 逐次生成されることを目視するため、ウェイトをはさむ
    time.sleep(0.3)


# トークンの入力が終わったら、最後に flush して残っているバッファを出力し切る
print(f"{tokf.flush()}", end="", flush=True)

```


<img src="tokflow.gif">


# 処理設計

## ストリーム置換処理について

逐次的に出現するトークン（文字列の断片）を順次読み込み、
読み込んだトークンは、これまで読み込んだトークンと結合する。

これまで読み込まれ結合されたトークンをトークンバッファと呼ぶ。

この処理を順次行うとき、トークンバッファ内にあらかじめ指定しておいて文字列（以降、これを「検索対象文字列」と呼ぶ）が出現したとき、
その文字列を別の文字列（以降、これを「置換先文字列」と呼ぶ）に置換する。


トークンは逐次的に読み込まれるため、中途段階では検索対象文字列とは無関係の文字列または検索対象文字列の一部がトークンバッファに蓄積されていく。

検索対象文字列になりえない順序でトークンバッファが構成された場合、
そう判断された瞬間にトークンバッファはメソッドの戻り値として返却される。


一方、検索対象文字列になり得る順序でトークンバッファが構成されている場合、検索対象文字列が出現するか、
検索対象文字列になりえないと判断されるまで、戻り値は空文字となる。


このように、検索対象文字列が出現するまでバッファリングさせることで、逐次トークンのほとんどはそのまま逐次表示させ、置換が必要な場合には表示を遅らせる、というストリーム処理することができる。

